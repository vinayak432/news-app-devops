pipeline {
    agent { label 'java' }

    stages {
        stage('Checkout') {
            steps {
                sh "rm -rf news-app-devops"
                sh "git clone 'https://github.com/vinayak432/news-app-devops.git'"
            }
        }

        stage('Version & Build') {
            steps {
                script {
                    def version = "1.0.${env.BUILD_NUMBER}"
                    echo "Setting project version to ${version}"

                    sh """
                      cd ${env.WORKSPACE}
                      mvn versions:set -DnewVersion=${version}
                      mvn clean package
                    """
                }
            }
        }
 
        stage('Test') {
            steps {
                sh "cd ${env.WORKSPACE} && mvn test"
            }
        }


stage('Push the artifacts into JFrog Artifactory') {
            steps {
                script {
                    // Get the current date and time in the format: yyyy-MM-dd_HH-mm
                    def currentDate = new java.text.SimpleDateFormat("yyyy-MM-dd_HH-mm").format(new Date())

                    // Define the target path with the timestamp
                    def targetPath = "feature_release1/${currentDate}/"

                    // Upload the built WAR to JFrog Artifactory with the timestamped path
                    rtUpload(
                        serverId: "jfrog",
                        spec: """{
                            "files": [
                                {
                                    "pattern": "${WAR_FILE}",
                                    "target": "${targetPath}"
                                }
                            ]
                        }"""
                    )
                }
            }
        }
    } // end stages


        stage('Deploy to Tomcat') {
            steps {
                sh """
                  # adjust WAR name if Maven uses versioned file name
                  echo 'Cleaning old deployment'
                  sudo rm -rf /opt/tomcat10/webapps/news-app /opt/tomcat10/webapps/news-app*.war

                  echo 'Copying new WAR'
                  sudo scp /home/slave1/workspace/jenkinsfilef12_feature-1/target/news-app.war /opt/tomcat10/webapps/

                  echo 'Restarting Tomcat'
                  sudo /opt/tomcat10/bin/shutdown.sh || true
                  sleep 2
                  sudo /opt/tomcat10/bin/startup.sh
                """
            }
        }
    }
}
